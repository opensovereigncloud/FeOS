name: FeOS Test

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Install Protobuf Compiler
      run: sudo apt-get update && sudo apt-get install protobuf-compiler curl -y

    - name: Set up cargo cache
      uses: actions/cache@v4
      continue-on-error: false
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ${{ runner.os }}-cargo-

    - name: Download and Install Youki
      run: |
        YOUKI_VERSION=$(cat hack/youki/version)
        YOUKI_FILENAME=youki
        YOUKI_ARCHIVE="${YOUKI_FILENAME}-${YOUKI_VERSION}-x86_64-musl.tar.gz"
        YOUKI_URL="https://github.com/youki-dev/youki/releases/download/v${YOUKI_VERSION}/${YOUKI_ARCHIVE}"
        DOWNLOAD_DIR=$(mktemp -d)

        echo "Downloading Youki v${YOUKI_VERSION} from ${YOUKI_URL}"
        curl -L "${YOUKI_URL}" -o "${DOWNLOAD_DIR}/${YOUKI_ARCHIVE}"

        echo "Extracting Youki..."
        tar -xzf "${DOWNLOAD_DIR}/${YOUKI_ARCHIVE}" -C "${DOWNLOAD_DIR}"

        echo "Installing Youki binary to /usr/local/bin..."
        sudo install -Dm755 "${DOWNLOAD_DIR}/${YOUKI_FILENAME}" "/usr/local/bin/${YOUKI_FILENAME}"

        echo "Cleaning up..."
        rm -rf "${DOWNLOAD_DIR}"

        echo "Verifying youki installation:"
        which youki
        youki --version

    - name: Run Tests
      env:
        RUST_BACKTRACE: 1
        SUDO_ENV_VARS: "PATH=$PATH:$HOME/.cargo/bin CARGO_HOME=$HOME/.cargo"
      run: |
        sudo -E bash -c ' \
          export PATH="$HOME/.cargo/bin:$PATH"; \
          export CARGO_HOME="$HOME/.cargo"; \
          make test \
        '
